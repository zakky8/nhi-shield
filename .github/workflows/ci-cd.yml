name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  security-events: write

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Backend API Tests
  api-tests:
    name: Backend API Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: nhishield_test
          POSTGRES_USER: nhiadmin
          POSTGRES_PASSWORD: ciTestOnly123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      neo4j:
        image: neo4j:5.15-community
        env:
          NEO4J_AUTH: neo4j/ciTestOnly123
        ports:
          - 7687:7687
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/api/package-lock.json
      
      - name: Install dependencies
        working-directory: backend/api
        run: npm ci || npm install
      
      - name: Run linter
        working-directory: backend/api
        run: npm run lint --if-present
      
      - name: Run tests
        working-directory: backend/api
        env:
          DATABASE_URL: postgresql://nhiadmin:ciTestOnly123@localhost:5432/nhishield_test
          NEO4J_URI: bolt://localhost:7687
          NEO4J_PASSWORD: ciTestOnly123
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: ciTestOnlyJwtKey2026ForActions
          ENCRYPTION_KEY: ciTestOnlyEncryptionKey32charsXX
          NODE_ENV: test
        run: npm test -- --coverage --forceExit --detectOpenHandles --runInBand
      
      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./backend/api/coverage/lcov.info
          flags: api
          name: api-coverage

  # Frontend Tests
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci || npm install
      
      - name: Run linter
        working-directory: frontend
        run: npm run lint --if-present
      
      - name: Run tests
        working-directory: frontend
        run: npm test -- --coverage --watchAll=false --passWithNoTests
      
      - name: Build production
        working-directory: frontend
        run: npm run build
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  # Python Services Tests
  python-tests:
    name: Python Services Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [discovery, anomaly, risk, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: backend/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      
      - name: Run tests
        working-directory: backend/${{ matrix.service }}
        run: pytest --cov=. --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/${{ matrix.service }}/coverage.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Run npm audit (API)
        working-directory: backend/api
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Run npm audit (Frontend)
        working-directory: frontend
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api
            context: ./backend/api
          - service: frontend
            context: ./frontend
          - service: discovery
            context: ./backend/discovery
          - service: anomaly
            context: ./backend/anomaly
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          push: false
          tags: nhi-shield-${{ matrix.service }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [api-tests, frontend-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Stop GHA Services
        run: |
          echo "Stopping GHA services to free up ports for Integration Tests..."
          docker stop $(docker ps -a -q --filter "label=com.github.actions.service=service") || true

      - name: Start services with Docker Compose
        run: |
          # Create required directories for volume mounts
          mkdir -p certs/api certs/ca
          touch certs/api/api.crt certs/api/api.key certs/ca/ca.crt

          cp .env.example .env
          # Use placeholder values for required env vars to prevent docker-compose error
          sed -i 's/CHANGE_ME_strong_password_here/ciPassword123/g' .env
          sed -i 's/CHANGE_ME_neo4j_password_here/ciPassword123/g' .env
          sed -i 's/CHANGE_ME_redis_password_here/ciPassword123/g' .env
          sed -i 's/CHANGE_ME_influx_password_here/ciPassword123/g' .env
          sed -i 's/CHANGE_ME_influx_token_here_min_16_chars/ciToken123456789/g' .env
          sed -i 's/CHANGE_ME_qdrant_api_key_here/ciApiKey123/g' .env
          sed -i 's/CHANGE_ME_generate_with_crypto_randomBytes_64/ciSecretKey123/g' .env
          sed -i 's/CHANGE_ME_32_chars_exactly_here!/ciTestOnlyEncryptionKey32charsXX/g' .env
          sed -i 's/CHANGE_ME_grafana_password_here/ciPassword123/g' .env

          # ensure required ports are free on the runner
          fuser -k 3000/tcp || true
          fuser -k 3001/tcp || true
          docker compose --project-directory . --project-name nhi_ci -f docker/docker-compose.yml up -d --build

      - name: Wait for services and perform health checks
        run: |
          # Wait for services with retries
          docker compose --project-directory . -f docker/docker-compose.yml ps
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:3000/health >/dev/null 2>&1; then
              echo "API healthy"
              break
            fi
            echo "Waiting for API (attempt $i/30)..."
            sleep 10
          done

          if ! curl -fsS http://localhost:3000/health >/dev/null 2>&1; then
            echo "ERROR: API did not become healthy after retries"
            docker compose --project-directory . -f docker/docker-compose.yml logs --no-color || true
            exit 1
          fi

          # Basic root check for frontend
          if ! curl -fsS http://localhost/ >/dev/null 2>&1; then
            echo "WARNING: Frontend root URL not responding after retries"
            docker compose --project-directory . -f docker/docker-compose.yml logs --no-color || true
          fi
      
      - name: Run integration tests
        run: |
          # Add integration test script here
          echo "Integration tests would run here"
      
      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose --project-directory . -f docker/docker-compose.yml logs
      
      - name: Cleanup
        if: always()
        run: |
          docker compose --project-directory . -f docker/docker-compose.yml down -v

  # Code Quality
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v4
        with:
          languages: javascript, python
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  # Deployment (only on main branch)
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [api-tests, frontend-tests, python-tests, docker-build, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to production
        run: |
          # Add deployment script here
          echo "Deployment would happen here"
          # Example: 
          # - Push Docker images to registry
          # - Update Kubernetes manifests
          # - Trigger deployment pipeline

  # Create Release (on tags)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [api-tests, frontend-tests, python-tests, docker-build]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build release artifacts
        run: |
          # Build production Docker images
          docker build -t nhi-shield-api:${{ github.ref_name }} backend/api
          docker build -t nhi-shield-frontend:${{ github.ref_name }} frontend
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: false
